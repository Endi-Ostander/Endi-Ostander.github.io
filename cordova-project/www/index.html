<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Desktop Mobile ‚Äî —É–ª—É—á—à–µ–Ω–Ω—ã–π</title>
<style>
  /* ========== –û–±—â–∏–µ —Å—Ç–∏–ª–∏ ========== */
  :root{
    --bg:#121212; --panel:#1e1e1e; --muted:#2a2a2a; --accent:#3a82f6; --danger:#d9534f; --text:#fff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, Arial, sans-serif;}
  #desktop{display:flex;flex-wrap:wrap;gap:15px;padding:15px;padding-right:260px;box-sizing:border-box;}
  .tile{width:80px;height:80px;background:var(--panel);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;user-select:none;}
  .tile:hover{transform:scale(1.05);background:#2c2c2c}
  .tile span{font-size:11px;text-align:center;word-break:break-word}
  #start-button{position:fixed;left:15px;bottom:15px;background:var(--panel);padding:12px 16px;border-radius:8px;cursor:pointer;z-index:150;box-shadow:0 6px 18px rgba(0,0,0,.6)}
  #start-menu{position:fixed;left:15px;bottom:60px;background:var(--panel);padding:12px;border-radius:8px;display:none;flex-direction:column;gap:8px;z-index:150;width:220px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  #start-menu.open{display:flex}
  #start-menu .row{display:flex;align-items:center;gap:8px}
  #start-menu button{background:transparent;border:none;color:var(--text);padding:8px;border-radius:6px;text-align:left;cursor:pointer}
  #start-menu button:hover{background:#2c2c2c}

  /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
  .context-menu{position:absolute;background:#2c2c2c;border-radius:6px;padding:5px 0;display:none;flex-direction:column;z-index:200;box-shadow:0 8px 30px rgba(0,0,0,.6)}
  .context-menu button{background:transparent;border:none;color:var(--text);padding:8px 12px;text-align:left;cursor:pointer}
  .context-menu button:hover{background:#3a3a3a}

  /* –†–µ–¥–∞–∫—Ç–æ—Ä */
  #editor-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;flex-direction:column;z-index:300}
  #editor-overlay textarea{flex:1;width:100%;background:#141414;color:var(--text);border:none;padding:12px;font-family:monospace;font-size:14px;resize:none}
  #editor-controls{display:flex;gap:8px;padding:8px;background:linear-gradient(180deg, rgba(0,0,0,.2), rgba(0,0,0,0));}

  /* Toasts ‚Äî –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ */
  #toast-container{position:fixed;right:18px;bottom:18px;z-index:600;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .toast{min-width:160px;max-width:360px;padding:10px 14px;border-radius:10px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.5);opacity:0;transform:translateX(20px) translateY(8px);animation:toast-in .36s forwards}
  .toast.info{background:#2a2a2a}
  .toast.success{background:linear-gradient(90deg,#2a2a2a,#2f7a5a)}
  .toast.error{background:linear-gradient(90deg,var(--danger),#b33)}
  @keyframes toast-in{to{opacity:1;transform:translateX(0) translateY(0)}}
  @keyframes toast-out{to{opacity:0;transform:translateX(20px) translateY(6px)}}

  /* –ü—Ä–æ–≤–æ–¥–Ω–∏–∫ (Explorer) ‚Äî –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
  #explorer-panel{position:fixed;right:0;top:0;height:100%;width:250px;background:#0f1113;border-left:1px solid rgba(255,255,255,.03);z-index:140;display:flex;flex-direction:column;padding:12px;box-sizing:border-box}
  #explorer-panel .header{font-weight:600;margin-bottom:10px}
  #explorer-tree{overflow:auto;flex:1;padding-right:6px}
  .expl-node{padding:6px 8px;border-radius:6px;color:#ddd;cursor:pointer;display:flex;align-items:center;gap:8px}
  .expl-node:hover{background:rgba(255,255,255,.02)}
  .expl-node .toggle{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:12px}
  .expl-children{margin-left:16px;display:none}
  .expl-children.open{display:block}
  .small-muted{font-size:12px;color:#9aa0a6}

  /* Responsive */
  @media (max-width:700px){
    #desktop{padding-right:0}
    #explorer-panel{width:100%;height:40%;bottom:0;top:auto;left:0;border-left:none;border-top:1px solid rgba(255,255,255,.03)}
  }
</style>
</head>
<body>

  <div id="desktop" aria-live="polite"></div>

  <div id="start-button" role="button" tabindex="0" aria-label="–ü—É—Å–∫" onclick="toggleStartMenu()">–ü—É—Å–∫</div>

  <div id="start-menu" aria-hidden="true">
    <div class="row"><strong>–ü—É—Å–∫</strong><div style="flex:1"></div><span class="small-muted">Mini Desktop</span></div>
    <button onclick="loadDesktop('')">–î–æ–º–æ–π</button>
    <button onclick="createFilePrompt()">–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</button>
    <button onclick="createFolderPrompt()">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
    <button onclick="openExplorer()">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</button>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:8px 0" />
    <!-- –ü–æ–º–µ—Ç–∫–∞: –∑–¥–µ—Å—å —Å–∫—Ä—ã—Ç—ã —è—Ä–ª—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º (–±—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –ø–æ–∑–∂–µ).
         –ü–æ–∫–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —è—Ä–ª—ã–∫–∏, –Ω–æ –º–µ—Å—Ç–æ –≤ –º–µ–Ω—é –æ—Å—Ç–∞–≤–ª–µ–Ω–æ. -->
    <div style="padding:6px 8px;color:#9aa0a6;font-size:13px">–Ø—Ä–ª—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º —Å–∫—Ä—ã—Ç—ã (–±—É–¥—É—Ç –ø–æ–∑–∂–µ)</div>
  </div>

  <div id="context-menu" class="context-menu" role="menu"></div>

  <div id="editor-overlay" role="dialog" aria-modal="true">
    <div id="editor-controls">
      <button onclick="saveFile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <div style="flex:1"></div>
      <span id="editor-path" class="small-muted"></span>
    </div>
    <textarea id="editor-text" spellcheck="false"></textarea>
  </div>

  <div id="explorer-panel" style="display:none">
    <div class="header">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</div>
    <div id="explorer-tree"></div>
    <div style="padding-top:10px">
      <button onclick="closeExplorer()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
/* ================== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–ª—é—á –∏ URL –∂–µ—Å—Ç–∫–æ ‚Äî –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) ================== */
const API_KEY = "SECRET123";
const BASE_URL = window.location.origin.includes(".ts.net")
  ? window.location.origin
  : "https://desktop-ehi37qq.tail096c20.ts.net:8888"; // fallback

let currentPath = "";
let selectedItem = null;
let editingFile = null;

/* ============ Toast: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ============ */
function showToast(message, type = "info", timeout = 3500) {
  try {
    const container = document.getElementById("toast-container");
    const t = document.createElement("div");
    t.className = "toast " + (type || "info");
    t.textContent = message;
    container.appendChild(t);
    // auto hide
    const hide = () => {
      t.style.animation = "toast-out .28s forwards";
      setTimeout(()=> t.remove(), 300);
    };
    setTimeout(hide, timeout);
    // click to close
    t.addEventListener("click", hide);
    return t;
  } catch (e) {
    console.warn("Toast error", e);
  }
}

/* ============ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ ============ */
function loadDesktop(path = "") {
  fetch(`${BASE_URL}/list?path=${encodeURIComponent(path)}`, {
    headers: {"X-API-KEY": API_KEY}
  })
  .then(async r => {
    if (!r.ok) {
      const txt = await r.text().catch(()=>r.statusText);
      throw new Error(`HTTP ${r.status}: ${txt}`);
    }
    return r.json();
  })
  .then(data => {
    if (!data || data.error) {
      showToast(data?.error || "–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞", "error");
      return;
    }
    currentPath = data.path || "";
    renderDesktop(data.items || []);
  })
  .catch(err => {
    showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + (err.message || err), "error");
  });
}

function renderDesktop(items) {
  const desktop = document.getElementById("desktop");
  desktop.innerHTML = "";

  // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Ç—å)
  if (currentPath) {
    const back = document.createElement("div");
    back.className = "tile";
    back.onclick = () => {
      const parts = currentPath.split("/").filter(Boolean);
      parts.pop();
      loadDesktop(parts.join("/"));
    };
    back.innerHTML = `<span style="font-size:36px">‚¨ÖÔ∏è</span><span>–ù–∞–∑–∞–¥</span>`;
    desktop.appendChild(back);
  }

  // Merge: server items + (hidden) shortcuts placeholder (we hide program shortcuts for now)
  // If later you enable shortcuts, you can prepend them here.
  items.forEach(item => {
    const d = document.createElement("div");
    d.className = "tile";
    d.oncontextmenu = e => { e.preventDefault(); showContextMenu(e, item); };
    d.ondblclick = () => { if (item.is_dir) { loadDesktop(currentPath ? currentPath + "/" + item.name : item.name); } else openEditor(item); };
    d.innerHTML = `<span style="font-size:36px">${item.is_dir ? "üìÅ" : "üìÑ"}</span><span>${item.name}</span>`;
    desktop.appendChild(d);
  });
}

/* ============ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ============ */
function showContextMenu(e, item) {
  selectedItem = item;
  const menu = document.getElementById("context-menu");
  menu.innerHTML = "";
  const actions = [
    {name: "–û—Ç–∫—Ä—ã—Ç—å", fn: ()=> { if (item.is_dir) loadDesktop(currentPath?currentPath+"/"+item.name:item.name); else openEditor(item); }},
    {name: "–£–¥–∞–ª–∏—Ç—å", fn: ()=> deleteItem(item)},
    {name: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", fn: ()=> copyItem(item)},
    {name: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å", fn: ()=> moveItem(item)}
  ];
  actions.forEach(a=>{
    const btn = document.createElement("button");
    btn.textContent = a.name;
    btn.onclick = ()=>{ a.fn(); hideContextMenu(); };
    menu.appendChild(btn);
  });
  menu.style.left = e.pageX + "px";
  menu.style.top = e.pageY + "px";
  menu.style.display = "flex";
}
function hideContextMenu(){ document.getElementById("context-menu").style.display = "none"; }
document.addEventListener("click", hideContextMenu);

/* ============ CRUD ============ */
function deleteItem(item){
  const fullPath = currentPath ? currentPath + "/" + item.name : item.name;
  fetch(`${BASE_URL}/delete`, {
    method: "POST",
    headers: {"Content-Type": "application/json","X-API-KEY": API_KEY},
    body: JSON.stringify({name: fullPath})
  })
  .then(r => r.json())
  .then(d => {
    if (d?.success) { showToast("–£–¥–∞–ª–µ–Ω–æ"); loadDesktop(currentPath); }
    else showToast(d?.error || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è", "error");
  })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}

function copyItem(item){
  const dst = prompt("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—É—Ç—å (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è):");
  if (!dst) return;
  const srcPath = currentPath ? currentPath + "/" + item.name : item.name;
  fetch(`${BASE_URL}/copy`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify({src: srcPath, dst: dst})
  })
  .then(r => r.json())
  .then(d => {
    if (d?.success) { showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); loadDesktop(currentPath); }
    else showToast(d?.error || "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", "error");
  })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}

function moveItem(item){
  const dst = prompt("–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –ø—É—Ç—å (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è):");
  if (!dst) return;
  const srcPath = currentPath ? currentPath + "/" + item.name : item.name;
  fetch(`${BASE_URL}/move`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify({src: srcPath, dst: dst})
  })
  .then(r => r.json())
  .then(d => {
    if (d?.success) { showToast("–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ"); loadDesktop(currentPath); }
    else showToast(d?.error || "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è", "error");
  })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}

/* ============ –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤/–ø–∞–ø–æ–∫ ============ */
function createFilePrompt(){
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º (.txt, .py –∏ –¥—Ä.):");
  if (!name) return;
  const payload = {name: currentPath ? currentPath + "/" + name : name};
  fetch(`${BASE_URL}/create_file`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify(payload)
  })
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json().catch(()=>({}));
  })
  .then(d => { showToast("–§–∞–π–ª —Å–æ–∑–¥–∞–Ω"); loadDesktop(currentPath); })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}

function createFolderPrompt(){
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
  if (!name) return;
  const payload = {name: currentPath ? currentPath + "/" + name : name};
  fetch(`${BASE_URL}/create_folder`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify(payload)
  })
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json().catch(()=>({}));
  })
  .then(d => { showToast("–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞"); loadDesktop(currentPath); })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}

/* ============ –†–µ–¥–∞–∫—Ç–æ—Ä ============ */
function openEditor(item){
  editingFile = currentPath ? currentPath + "/" + item.name : item.name;
  const overlay = document.getElementById("editor-overlay");
  overlay.style.display = "flex";
  document.getElementById("editor-path").textContent = editingFile;
  fetch(`${BASE_URL}/open_file`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify({name: editingFile})
  })
  .then(async r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.text();
  })
  .then(text => {
    document.getElementById("editor-text").value = text;
  })
  .catch(err => {
    showToast("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: " + (err.message || err), "error");
  });
}

function saveFile(){
  const content = document.getElementById("editor-text").value;
  if (!editingFile) { showToast("–ù–µ—Ç —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error"); return; }
  fetch(`${BASE_URL}/save_file`, {
    method:"POST", headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body: JSON.stringify({name: editingFile, content})
  })
  .then(r => r.json())
  .then(d => {
    if (d?.success) showToast("–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω", "success");
    else showToast(d?.error || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "error");
  })
  .catch(err => showToast("–û—à–∏–±–∫–∞: " + err, "error"));
}
function closeEditor(){ document.getElementById("editor-overlay").style.display = "none"; }

/* ============ Explorer (–ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞) ============ */
function openExplorer(){
  document.getElementById("explorer-panel").style.display = "flex";
  document.getElementById("start-menu").classList.remove("open");
  buildExplorerRoot("");
}

function closeExplorer(){
  document.getElementById("explorer-panel").style.display = "none";
}

function buildExplorerRoot(rootPath){
  const tree = document.getElementById("explorer-tree");
  tree.innerHTML = "";
  // —Å–æ–∑–¥–∞—ë–º root node
  const rootNode = createExplorerNode({name: rootPath || "/", path: rootPath || "", is_dir: true}, true);
  tree.appendChild(rootNode);

  // –∏—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–µ—Ç–µ–π root
  const childrenContainer = rootNode.querySelector(".explorer-children");

  // —Å—Ä–∞–∑—É —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º root
  toggleExplorerNode(rootNode, childrenContainer);
}


function createExplorerNode(item, isRoot = false) {
    const wrapper = document.createElement("div");
    wrapper.className = "explorer-node";

    const header = document.createElement("div");
    header.className = "explorer-header";
    header.textContent = item.name || "root";

    const childrenContainer = document.createElement("div");
    childrenContainer.className = "explorer-children hidden";

    // ‚úÖ –≤—Å–µ–≥–¥–∞ –∑–∞–¥–∞—ë–º dataset.path
    wrapper.dataset.path = (item.path !== undefined && item.path !== null) ? item.path : "";

    if (item.is_dir) {
        header.classList.add("folder");
        header.addEventListener("click", () => toggleExplorerNode(wrapper, childrenContainer));
    } else {
        header.classList.add("file");
        header.addEventListener("click", () => openFile(wrapper.dataset.path));
    }

    wrapper.appendChild(header);
    wrapper.appendChild(childrenContainer);

    return wrapper;
}

async function toggleExplorerNode(node, container) {
    const path = node.dataset.path ?? "";

    console.log("Explorer fetch path:", path); // üîç –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    // –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä—ã—Ç ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    if (container.classList.contains("hidden")) {
        try {
            const res = await fetch(`${BASE_URL}/list?path=${encodeURIComponent(path)}`, {
                headers: { "X-API-Key": API_KEY }
            });

            if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}`);

            const data = await res.json();
            container.innerHTML = ""; // –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ
            data.items.forEach(dir => {
                const childPath = path ? path + "/" + dir.name : dir.name;
                const childNode = createExplorerNode({ 
                    name: dir.name, 
                    path: childPath, 
                    is_dir: dir.is_dir 
                });
                container.appendChild(childNode);
            });
        } catch (err) {
            showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É: " + err.message, "error");
            console.error(err);
        }
    }

    container.classList.toggle("hidden");
}


/* ============ UI helpers ============ */
function toggleStartMenu(){
  const m = document.getElementById("start-menu");
  m.classList.toggle("open");
}

/* ============ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ============ */
document.addEventListener("DOMContentLoaded", ()=> {
  loadDesktop("");
  // hide explorer on outside click (mobile-friendly)
  document.addEventListener("click", (e)=>{
    const start = document.getElementById("start-menu");
    const btn = document.getElementById("start-button");
    if (!start.contains(e.target) && !btn.contains(e.target)) start.classList.remove("open");
  });
});
</script>

</body>
</html>

