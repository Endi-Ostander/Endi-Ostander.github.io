<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Desktop Mobile</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #121212;
  color: #fff;
  overflow-x: hidden;
}

#desktop {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  padding: 15px;
  gap: 15px;
}

.tile {
  width: 80px;
  height: 80px;
  background: #1e1e1e;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}
.tile:hover { background: #2c2c2c; transform: scale(1.05); }
.tile span { text-align: center; font-size: 11px; word-break: break-word; }

#start-button {
  position: fixed;
  bottom: 15px;
  left: 15px;
  background: #1e1e1e;
  color: #fff;
  padding: 12px 20px;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 0 5px #000;
  z-index: 100;
}

#start-menu {
  position: fixed;
  bottom: 60px;
  left: 15px;
  background: #1e1e1e;
  padding: 12px;
  border-radius: 6px;
  display: none;
  flex-direction: column;
  gap: 8px;
  box-shadow: 0 0 5px #000;
}
#start-menu.open { display: flex; }
#start-menu button {
  background: #2a2a2a;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
}
#start-menu button:hover { background: #3a3a3a; }

.context-menu {
  position: absolute;
  background: #2c2c2c;
  border-radius: 6px;
  display: none;
  flex-direction: column;
  padding: 5px 0;
  z-index: 200;
  box-shadow: 0 0 10px #000;
}
.context-menu button {
  background: transparent;
  color: #fff;
  border: none;
  padding: 6px 15px;
  text-align: left;
  cursor: pointer;
}
.context-menu button:hover { background: #3a3a3a; }
#editor-overlay {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.95);
  display: none;
  flex-direction: column;
  z-index: 300;
}
#editor-overlay textarea {
  flex: 1;
  width: 100%;
  background: #1e1e1e;
  color: #fff;
  border: none;
  padding: 10px;
  font-family: monospace;
  font-size: 14px;
  resize: none;
}
#editor-overlay button {
  padding: 10px;
  border: none;
  background: #2a2a2a;
  color: #fff;
  cursor: pointer;
}
#editor-overlay button:hover { background: #3a3a3a; }
</style>
</head>
<body>

<div id="desktop"></div>
<div id="start-button" onclick="toggleStartMenu()">–ü—É—Å–∫</div>
<div id="start-menu">
  <button onclick="loadDesktop('')">–î–æ–º–æ–π</button>
  <button onclick="createFilePrompt()">–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</button>
  <button onclick="createFolderPrompt()">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
</div>

<div id="editor-overlay">
  <textarea id="editor-text"></textarea>
  <button onclick="saveFile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="closeEditor()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div id="context-menu" class="context-menu"></div>

<script>
const API_KEY = "SECRET123";
const BASE_URL = window.location.origin.includes(".ts.net")
  ? window.location.origin
  : "https://desktop-ehi37qq.tail096c20.ts.net:8888";
let currentPath = "";
let selectedItem = null;

// ==================== –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ====================
function loadDesktop(path="") {
  fetch(`${BASE_URL}/list?path=${encodeURIComponent(path)}`, { headers: {"X-API-KEY":API_KEY} })
    .then(r=>r.json())
    .then(data=>{
      if(data.error){alert(data.error); return;}
      currentPath = data.path;
      const desktop = document.getElementById("desktop");
      desktop.innerHTML = "";

      // –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
      if(currentPath){
        const back = document.createElement("div");
        back.className="tile";
        back.onclick=()=>{ const parts=currentPath.split("/").filter(Boolean); parts.pop(); loadDesktop(parts.join("/"))};
        back.innerHTML=`<span style="font-size:36px;">‚¨ÖÔ∏è</span><span>–ù–∞–∑–∞–¥</span>`;
        desktop.appendChild(back);
      }

      data.items.forEach(item=>{
        const div = document.createElement("div");
        div.className="tile";
        div.oncontextmenu = (e)=>{ e.preventDefault(); showContextMenu(e,item); };
        div.ondblclick = ()=>{ if(item.is_dir) loadDesktop(currentPath?currentPath+"/"+item.name:item.name); else openEditor(item); };
        div.innerHTML=`<span style="font-size:36px;">${item.is_dir?"üìÅ":"üìÑ"}</span><span>${item.name}</span>`;
        desktop.appendChild(div);
      });
    }).catch(err=>alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: "+err));
}

// ==================== –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ====================
function showContextMenu(e,item){
  selectedItem = item;
  const menu = document.getElementById("context-menu");
  menu.innerHTML="";
  const actions = [
    {name:"–û—Ç–∫—Ä—ã—Ç—å", fn:()=>{ if(item.is_dir) loadDesktop(currentPath?currentPath+"/"+item.name:item.name); else openEditor(item); }},
    {name:"–£–¥–∞–ª–∏—Ç—å", fn:()=>deleteItem(item)},
    {name:"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", fn:()=>copyItem(item)},
    {name:"–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å", fn:()=>moveItem(item)}
  ];
  actions.forEach(a=>{
    const btn = document.createElement("button");
    btn.innerText=a.name;
    btn.onclick=()=>{ a.fn(); hideContextMenu(); };
    menu.appendChild(btn);
  });
  menu.style.left=e.pageX+"px";
  menu.style.top=e.pageY+"px";
  menu.style.display="flex";
}
document.addEventListener("click", hideContextMenu);
function hideContextMenu(){document.getElementById("context-menu").style.display="none";}

// ==================== CRUD ====================
function deleteItem(item){
  const fullPath=currentPath?currentPath+"/"+item.name:item.name;
  fetch(`${BASE_URL}/delete`,{
    method:"POST",
    headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body:JSON.stringify({name:fullPath})
  }).then(r=>r.json()).then(d=>{if(d.success) loadDesktop(currentPath); else alert(d.error)});
}

function copyItem(item){
  const dst = prompt("–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—É—Ç—å (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è):");
  if(!dst) return;
  const srcPath=currentPath?currentPath+"/"+item.name:item.name;
  fetch(`${BASE_URL}/copy`,{
    method:"POST",
    headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body:JSON.stringify({src:srcPath,dst:dst})
  }).then(r=>r.json()).then(d=>{if(d.success) loadDesktop(currentPath); else alert(d.error)});
}

function moveItem(item){
  const dst = prompt("–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –ø—É—Ç—å (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è):");
  if(!dst) return;
  const srcPath=currentPath?currentPath+"/"+item.name:item.name;
  fetch(`${BASE_URL}/move`,{
    method:"POST",
    headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body:JSON.stringify({src:srcPath,dst:dst})
  }).then(r=>r.json()).then(d=>{if(d.success) loadDesktop(currentPath); else alert(d.error)});
}

// ==================== –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤/–ø–∞–ø–æ–∫ ====================
function createFilePrompt(){
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º (.txt, .py –∏ –¥—Ä.):");
  if(!name) return;
  fetch(`${BASE_URL}/create_file`,{
    method:"POST",
    headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body:JSON.stringify({name:currentPath?currentPath+"/"+name:name})
  }).then(()=>loadDesktop(currentPath));
}

function createFolderPrompt(){
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
  if(!name) return;
  fetch(`${BASE_URL}/create_folder`,{
    method:"POST",
    headers:{"Content-Type":"application/json","X-API-KEY":API_KEY},
    body:JSON.stringify({name:currentPath?currentPath+"/"+name:name})
  }).then(()=>loadDesktop(currentPath));
}


// ==================== –†–µ–¥–∞–∫—Ç–æ—Ä ====================
let editingFile = null;
function openEditor(item){
  editingFile = currentPath?currentPath+"/"+item.name:item.name;
  const editor = document.getElementById("editor-overlay");
  editor.style.display="flex";
  fetch(`${BASE_URL}/open_file`,{headers:{"X-API-KEY":API_KEY},method:"POST",body:JSON.stringify({name:editingFile})})
  .then(r=>r.text()).then(t=>document.getElementById("editor-text").value=t);
}
function saveFile(){
  fetch(`${BASE_URL}/save_file`,{
    headers:{"X-API-KEY":API_KEY,"Content-Type":"application/json"},
    method:"POST",
    body:JSON.stringify({name:editingFile,content:document.getElementById("editor-text").value})
  }).then(r=>r.json()).then(d=>{ if(d.success) alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); else alert(d.error); });
}
function closeEditor(){
  document.getElementById("editor-overlay").style.display="none";
}

// ==================== –ú–µ–Ω—é –ü—É—Å–∫ ====================
function toggleStartMenu(){document.getElementById("start-menu").classList.toggle("open");}

loadDesktop();
</script>

</body>
</html>
